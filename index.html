<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AmazingTravel - å°ˆæ¥­é›²ç«¯è¡Œç¨‹ç®¡ç†</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <!-- Service Worker è¨»å†Šè…³æœ¬ -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          if (window.location.protocol.startsWith('http')) {
            navigator.serviceWorker.register('sw.js').catch(function(err) {
              console.warn('PWA ServiceWorker è¨»å†Šå—é™ï¼š', err);
            });
          }
        });
      }
    </script>

    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; overscroll-behavior-y: none; }
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border-radius: 1rem; }
        .destination-card { cursor: pointer; transition: all 0.15s ease; padding: 0.75rem 1rem; border-radius: 0.5rem; border-left-width: 4px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); background: white; }
        .destination-card:hover { transform: translateY(-1px); background-color: #f0fdfa; }
        .unscheduled { border-color: #f87171; }
        .scheduled { border-color: #34d399; }
        .itinerary-item { border-left: 4px solid #4f46e5; padding: 0.6rem 1rem; margin-bottom: 0.5rem; border-radius: 0.25rem; display: flex; justify-content: space-between; align-items: center; }
        .time-tag { font-weight: bold; font-size: 0.8rem; padding: 4px 10px; border-radius: 9999px; margin-right: 0.75rem; display: inline-block; }
        .modal { transition: opacity 0.25s ease; z-index: 100; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .online { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
        .offline { background-color: #9ca3af; }
        select { appearance: none; -webkit-appearance: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- é ‚éƒ¨å°èˆª -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
            <div class="mb-4 md:mb-0">
                <h1 class="text-3xl font-bold text-gray-800 tracking-tight">AmazingTravel</h1>
                <div class="flex items-center space-x-3 mt-1">
                    <span class="text-xs flex items-center text-gray-400 text-nowrap">
                        <span id="status-dot" class="status-dot offline"></span>
                        <span id="status-text">é€£ç·šä¸­...</span>
                    </span>
                    <span id="mode-badge" class="px-2 py-0.5 bg-gray-200 text-gray-600 text-[10px] rounded uppercase font-bold">æœ¬åœ°æ¨¡å¼</span>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2">
                <button onclick="copyItineraryToClipboard()" class="flex items-center px-4 py-2 bg-teal-600 text-white rounded-lg shadow hover:bg-teal-700 transition text-sm font-semibold">
                    è¤‡è£½æ–‡å­—
                </button>
                <button onclick="openCloudModal()" class="flex items-center px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg border border-indigo-100 hover:bg-indigo-100 transition text-sm font-bold">
                    é›²ç«¯èˆ‡å…±äº«
                </button>
                <button onclick="openTripManagerModal()" class="flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition text-sm font-bold">
                    è¡Œç¨‹ç®¡ç† (<span id="saved-count-badge">0</span>)
                </button>
            </div>
        </div>

        <!-- å¸¸ç”¨æ©Ÿå ´æ¸…å–® -->
        <datalist id="popular-airports">
            <option value="é¦™æ¸¯åœ‹éš›æ©Ÿå ´ (HKG) T1">
            <option value="æ±äº¬æˆç”°æ©Ÿå ´ (NRT)">
            <option value="æ±äº¬ç¾½ç”°æ©Ÿå ´ (HND)">
            <option value="å¤§é˜ªé—œè¥¿æ©Ÿå ´ (KIX)">
            <option value="é¦–çˆ¾ä»å·æ©Ÿå ´ (ICN)">
            <option value="é¦–çˆ¾é‡‘æµ¦æ©Ÿå ´ (GMP)">
            <option value="æ›¼è°·è˜‡å‡¡ç´å¸ƒæ©Ÿå ´ (BKK)">
            <option value="æ›¼è°·å»Šæ›¼æ©Ÿå ´ (DMK)">
            <option value="å°åŒ—æ¡ƒåœ’æ©Ÿå ´ (TPE)">
            <option value="å°åŒ—æ¾å±±æ©Ÿå ´ (TSA)">
            <option value="é«˜é›„å°æ¸¯æ©Ÿå ´ (KHH)">
            <option value="ç¦å²¡æ©Ÿå ´ (FUK)">
            <option value="æœ­å¹Œæ–°åƒæ­²æ©Ÿå ´ (CTS)">
            <option value="æ²–ç¹©é‚£éœ¸æ©Ÿå ´ (OKA)">
            <option value="æ–°åŠ å¡æ¨Ÿå®œæ©Ÿå ´ (SIN)">
            <option value="æ¾³é–€åœ‹éš›æ©Ÿå ´ (MFM)">
            <option value="ä¸Šæµ·æµ¦æ±æ©Ÿå ´ (PVG)">
        </datalist>

        <!-- æ—…è¡ŒåŸºæœ¬è³‡æ–™ -->
        <div class="card bg-white p-6 mb-6">
            <h2 class="text-xl font-semibold text-indigo-700 mb-4 font-bold">æ—…è¡ŒåŸºæœ¬è³‡æ–™</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 font-bold mb-1">å‡ºç™¼æ—¥æœŸ</label>
                    <input type="date" id="start-date" onchange="handleInputChange()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-200 focus:border-indigo-400 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 font-bold mb-1">å›ç¨‹æ—¥æœŸ</label>
                    <input type="date" id="end-date" onchange="handleInputChange()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-200 focus:border-indigo-400 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 font-bold mb-1">å…¥ä½é…’åº—</label>
                    <div class="mt-1 flex space-x-2">
                        <input type="text" id="hotel-name" onchange="handleInputChange()" placeholder="é…’åº—åç¨±" class="block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-200 focus:border-indigo-400 outline-none">
                        <button onclick="openHotelMap()" class="p-2 text-blue-500 bg-blue-50 hover:bg-blue-100 rounded-md border border-blue-200 transition shadow-sm" title="Google Map æœå°‹é…’åº—">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-100 font-bold text-gray-600">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">ğŸ›« å»ç¨‹èˆªç­</label>
                    <div class="grid grid-cols-2 gap-2 mt-2 font-normal">
                        <input type="text" id="depart-location" list="popular-airports" placeholder="æ©Ÿå ´/åŸå¸‚" onchange="handleInputChange()" class="text-sm p-2 border rounded-md outline-none">
                        <input type="time" id="depart-time" onchange="handleInputChange()" class="text-sm p-2 border rounded-md outline-none">
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-100 font-bold text-gray-600">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">ğŸ›¬ å›ç¨‹èˆªç­</label>
                    <div class="grid grid-cols-2 gap-2 mt-2 font-normal">
                        <input type="text" id="return-location" list="popular-airports" placeholder="æ©Ÿå ´/åŸå¸‚" onchange="handleInputChange()" class="text-sm p-2 border rounded-md outline-none">
                        <input type="time" id="return-time" onchange="handleInputChange()" class="text-sm p-2 border rounded-md outline-none">
                    </div>
                </div>
            </div>
        </div>

        <!-- åŒ¯ç‡æ›ç®—å·¥å…· -->
        <div class="card bg-white p-6 mb-6 border-l-4 border-green-500">
            <h2 class="text-xl font-semibold text-green-700 mb-4 flex items-center font-bold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                å³æ™‚åŒ¯ç‡å·¥å…·
            </h2>
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-1 w-full">
                    <label class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">æŒæœ‰è²¨å¹£</label>
                    <select id="base-currency" class="w-full p-2 border rounded-md font-bold text-gray-700 bg-gray-50 outline-none">
                        <option value="HKD">HKD - æ¸¯å¹£</option>
                        <option value="TWD">TWD - æ–°å°å¹£</option>
                        <option value="JPY">JPY - æ—¥åœ“</option>
                        <option value="KRW">KRW - éŸ“åœœ</option>
                        <option value="USD">USD - ç¾å…ƒ</option>
                        <option value="CNY">CNY - äººæ°‘å¹£</option>
                        <option value="EUR">EUR - æ­å…ƒ</option>
                    </select>
                </div>
                <button onclick="swapCurrencies()" class="p-2 mt-4 bg-gray-100 rounded-full hover:bg-indigo-100 transition shadow-sm border border-gray-200" title="å·¦å³å°æ›">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                </button>
                <div class="flex-1 w-full">
                    <label class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">å…Œæ›è²¨å¹£</label>
                    <select id="target-currency" class="w-full p-2 border rounded-md font-bold text-gray-700 bg-gray-50 outline-none">
                        <option value="JPY" selected>JPY - æ—¥åœ“</option>
                        <option value="TWD">TWD - æ–°å°å¹£</option>
                        <option value="HKD">HKD - æ¸¯å¹£</option>
                        <option value="KRW">KRW - éŸ“åœœ</option>
                        <option value="USD">USD - ç¾å…ƒ</option>
                        <option value="CNY">CNY - äººæ°‘å¹£</option>
                        <option value="EUR">EUR - æ­å…ƒ</option>
                    </select>
                </div>
                <div class="flex-1 w-full">
                    <label class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">é‡‘é¡</label>
                    <input type="number" id="exchange-amount" value="1000" class="w-full p-2 border rounded-md font-mono text-indigo-700 outline-none focus:ring-1 focus:ring-green-400">
                </div>
                <button onclick="fetchExchangeRate()" class="bg-green-600 text-white px-6 py-2 rounded-md font-bold hover:bg-green-700 transition w-full md:w-auto self-end h-[42px] shadow-sm">æ›ç®—</button>
            </div>
            <div id="exchange-result" class="mt-4 hidden p-4 bg-green-50 rounded-xl border border-green-200 text-center md:text-left">
                <span id="exchange-result-text" class="text-3xl font-black text-green-800 leading-tight tracking-tight">--</span>
                <!-- æ–°å¢åƒè€ƒä¾†æºæ¨™ç¤º -->
                <p class="text-[10px] text-gray-400 mt-1 text-right">è³‡æ–™ä¾†æºï¼šExchangeRate-API</p>
            </div>
        </div>

        <!-- ç›®çš„åœ°ç®¡ç† (é è¨­æ”¶åˆ) -->
        <div class="card bg-white p-6 mb-8 overflow-hidden">
            <div class="flex justify-between items-center cursor-pointer select-none" onclick="toggleDestinationSection()">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center font-bold">
                    ç›®çš„åœ°æ¸…å–®
                    <svg id="dest-chevron" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div class="flex space-x-3 items-center" onclick="event.stopPropagation()">
                    <label class="text-xs text-indigo-600 font-bold flex items-center cursor-pointer hover:underline text-nowrap">
                        åŒ¯å…¥ TXT
                        <input type="file" id="import-txt" accept=".txt" onchange="importDestinationsFromTxt(event)" class="hidden">
                    </label>
                    <button onclick="handleClearAllDestinations()" class="text-xs text-red-500 font-bold uppercase tracking-tight text-nowrap">æ¸…ç©ºå…¨éƒ¨</button>
                </div>
            </div>
            
            <div id="dest-section-content" class="hidden mt-4">
                <div class="flex space-x-2 mb-4 font-bold">
                    <input type="text" id="new-destination-name" placeholder="æ–°å¢åœ°é» (å¯é€—è™Ÿåˆ†éš”)" class="flex-grow rounded-md border-gray-300 shadow-sm p-2 border text-sm outline-none focus:ring-1 focus:ring-indigo-400">
                    <button onclick="addCustomDestination()" class="px-6 py-2 bg-indigo-600 text-white rounded-md text-sm font-bold shadow hover:bg-indigo-700 transition">æ–°å¢</button>
                </div>
                <div id="destination-list-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
            </div>
        </div>

        <!-- æ¯æ—¥è¡Œç¨‹é è¦½ -->
        <div id="itinerary-display-area" class="space-y-6 mb-20"></div>
    </div>

    <!-- é›²ç«¯å…±äº«å½ˆçª— -->
    <div id="cloud-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] hidden modal">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md mx-4 border border-indigo-100">
            <h3 class="text-xl font-bold mb-6 text-indigo-700 text-center border-b pb-2 font-bold">é›²ç«¯åŒæ­¥è¨­å®š</h3>
            <div class="space-y-6">
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <label class="block text-sm font-bold text-gray-700 mb-2">åŒæ­¥æ¨¡å¼</label>
                    <div class="flex p-1 bg-gray-200 rounded-lg">
                        <button id="btn-mode-private" onclick="switchSyncMode('private')" class="flex-1 py-2 text-sm font-bold rounded-md transition duration-200">å„è‡ªç¨ç«‹</button>
                        <button id="btn-mode-shared" onclick="switchSyncMode('shared')" class="flex-1 py-2 text-sm font-medium rounded-md transition duration-200">è³‡æ–™å…±äº«</button>
                    </div>
                    <p id="mode-desc-text" class="text-[10px] text-gray-400 mt-2 text-center">ç¨ç«‹æ¨¡å¼æœƒå°‡è³‡æ–™ä¿å­˜åœ¨æ‚¨çš„ç§æœ‰ç©ºé–“ã€‚</p>
                </div>
                <div id="shared-input-area" class="hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-2 font-bold text-indigo-600">å…±äº«é‡‘é‘° (Share ID)</label>
                    <div class="flex space-x-2">
                        <input type="text" id="share-id-input" placeholder="ä¾‹å¦‚: FUKUOKA2026" class="flex-grow p-2 border rounded-md font-mono uppercase outline-none focus:ring-1 focus:ring-indigo-500">
                        <button onclick="joinSharedTrip()" class="bg-indigo-600 text-white px-6 py-2 rounded-md text-sm font-bold">åŠ å…¥</button>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex flex-col items-center border-t pt-4">
                <div class="text-[10px] text-gray-400 mb-4 font-mono">
                    æ‚¨çš„è£ç½® ID: <span id="my-user-id" class="text-gray-600 font-bold">è¼‰å…¥ä¸­...</span>
                </div>
                <button onclick="closeCloudModal()" class="px-12 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- è¡Œç¨‹ç®¡ç†ä¸­å¿ƒ -->
    <div id="trip-manager-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] hidden modal">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-lg mx-4">
            <h3 class="text-xl font-bold mb-4 text-indigo-700 text-center font-bold tracking-tight">è¡Œç¨‹ç®¡ç†ä¸­å¿ƒ</h3>
            <div class="bg-indigo-50 p-4 rounded-xl mb-4 border border-indigo-100">
                <label class="block text-xs font-bold text-indigo-600 mb-2 uppercase tracking-tight">å°‡ç›®å‰è¡Œç¨‹å¦å­˜ç‚ºå‚™ä»½</label>
                <div class="flex space-x-2">
                    <input type="text" id="save-trip-name" placeholder="è¼¸å…¥è¡Œç¨‹æ¨™é¡Œ" class="flex-grow p-2 border rounded-md text-sm outline-none">
                    <button onclick="saveToLibrary()" class="bg-indigo-600 text-white px-5 py-2 rounded-md font-bold hover:bg-indigo-700 transition">å„²å­˜</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-6 font-bold">
                <button onclick="exportCurrentTrip()" class="py-3 bg-gray-50 text-gray-700 rounded-xl text-xs font-bold border border-gray-200 hover:bg-gray-100 transition shadow-sm">ğŸ“¤ åŒ¯å‡º JSON</button>
                <label class="py-3 bg-gray-50 text-gray-700 rounded-xl text-xs font-bold border border-gray-200 hover:bg-gray-100 cursor-pointer transition text-center flex items-center justify-center shadow-sm">
                    ğŸ“¥ åŒ¯å…¥ JSON
                    <input type="file" id="import-json-file" accept=".json" onchange="importTripFromFile(event)" class="hidden">
                </label>
            </div>
            <div class="max-h-60 overflow-y-auto space-y-2 border-t pt-4" id="library-list"></div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeTripManagerModal()" class="px-8 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold transition hover:bg-gray-200">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- é€šç”¨ç¢ºèªå°è©±æ¡† -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[200] hidden modal">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-2 tracking-tight">ç¢ºèªåŸ·è¡Œï¼Ÿ</h3>
            <p id="confirm-message" class="text-gray-500 mb-6 text-sm leading-relaxed font-medium"></p>
            <div class="flex space-x-3 font-bold">
                <button onclick="closeConfirmModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold transition hover:bg-gray-200">å–æ¶ˆ</button>
                <button id="confirm-ok-btn" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold shadow-lg shadow-red-200 transition hover:bg-red-600">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- è¡Œç¨‹ç´°ç¯€è¨­å®šå½ˆçª— -->
    <div id="date-selector-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[110] hidden modal">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm mx-4 font-bold">
            <h3 id="modal-title" class="text-lg font-bold mb-4 text-indigo-700 border-b pb-2 tracking-tight">è¡Œç¨‹ç´°ç¯€</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-[10px] text-gray-500 font-bold uppercase">é–‹å§‹</label><input type="time" id="m-start-time" class="w-full p-2 border rounded-md outline-none"></div>
                    <div><label class="text-[10px] text-gray-500 font-bold uppercase">çµæŸ</label><input type="time" id="m-end-time" class="w-full p-2 border rounded-md outline-none"></div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[10px] text-gray-500 font-bold uppercase tracking-tight">äº¤é€š</label>
                        <select id="m-transport" class="w-full p-2 border rounded-md text-sm bg-white outline-none">
                            <option value="åœ°éµ/ç«è»Š">åœ°éµ/ç«è»Š</option><option value="å·´å£«">å·´å£«</option><option value="æ­¥è¡Œ">æ­¥è¡Œ</option>
                            <option value="è¨ˆç¨‹è»Š/Uber">è¨ˆç¨‹è»Š/Uber</option><option value="è‡ªé§•">è‡ªé§•</option><option value="æ¸¡è¼ª">æ¸¡è¼ª</option>
                        </select>
                    </div>
                    <div><label class="text-[10px] text-gray-500 font-bold uppercase tracking-tight">äººå‡é ç®—</label><input type="text" id="m-cost" class="w-full p-2 border rounded-md text-sm outline-none"></div>
                </div>
                <div><label class="text-[10px] text-gray-500 font-bold uppercase tracking-tight">é¸æ“‡æ—¥æœŸ</label><div id="m-date-options" class="mt-1 space-y-1 max-h-32 overflow-y-auto border rounded-md p-1 bg-gray-50 font-bold text-gray-700"></div></div>
            </div>
            <div class="mt-6 flex justify-between items-center border-t pt-4">
                <button onclick="unassignDestination()" class="text-red-500 text-sm font-bold hover:underline">å–æ¶ˆæ’å®š</button>
                <div class="space-x-2 flex">
                    <button onclick="closeDateModal()" class="px-4 py-2 text-gray-400 font-medium">å–æ¶ˆ</button>
                    <button onclick="saveDateAssignment()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow-sm hover:bg-indigo-700 transition">ç¢ºèª</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- åˆå§‹åŒ–åƒæ•¸ ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'amazing-travel-asia-pro-v16';

        let currentUser = null;
        let currentMode = 'private'; 
        let currentShareId = '';
        let unsubscribeSync = null;
        let unsubscribeLibrary = null;

        const LOCAL_STORAGE_KEY = 'amazing_travel_local_v1';

        // é è¨­è³‡æ–™
        let appData = {
            inputs: { startDate: '', endDate: '', hotelName: '', departLocation: '', departTime: '10:00', returnLocation: '', returnTime: '18:30' },
            destinations: [],
            dailyOrder: {} 
        };

        let activeEditingName = null;

        // --- æœ¬åœ°æŒä¹…åŒ– (LocalStorage) å‡½å¼ ---
        function saveLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData));
            } catch(e) { console.warn("Local Save Error", e); }
        }

        function loadLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (data) {
                    const parsed = JSON.parse(data);
                    // åˆä½µä»¥ç¢ºä¿æ–°æ¬„ä½å­˜åœ¨
                    appData = { ...appData, ...parsed };
                    updateUI(); // ç«‹å³æ›´æ–°ç•«é¢
                }
            } catch(e) { console.warn("Local Load Error", e); }
        }

        // --- æ ¸å¿ƒå·¥å…· ---
        function getDaysArray(s, e) {
            if (!s || !e) return [];
            const start = new Date(s), end = new Date(e);
            if (isNaN(start) || isNaN(end) || start > end) return [];
            const days = [];
            let curr = new Date(start);
            while (curr <= end) {
                const iso = curr.toISOString().split('T')[0];
                days.push({ 
                    date: iso, 
                    display: curr.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric', weekday: 'short' }), 
                    isFirst: iso === s, 
                    isLast: iso === e 
                });
                curr.setDate(curr.getDate() + 1);
            }
            return days;
        }

        // --- é›²ç«¯èˆ‡è³‡æ–™æµ ---
        const syncDataToCloud = async () => {
            saveLocal(); // åŒæ­¥å¯«å…¥æœ¬åœ°
            if (!currentUser) return;
            let syncDocRef;
            if (currentMode === 'private') {
                syncDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'trips', 'active');
            } else {
                if (!currentShareId) return;
                syncDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared_trips', currentShareId);
            }
            try { await setDoc(syncDocRef, appData); } catch (err) {}
        };

        const updateUI = () => {
            const fields = { 'start-date': 'startDate', 'end-date': 'endDate', 'hotel-name': 'hotelName', 'depart-location': 'departLocation', 'depart-time': 'departTime', 'return-location': 'returnLocation', 'return-time': 'returnTime' };
            Object.entries(fields).forEach(([id, key]) => {
                const el = document.getElementById(id);
                if (el) el.value = appData.inputs[key] || '';
            });

            const container = document.getElementById('destination-list-container');
            if (container) {
                container.innerHTML = appData.destinations.map(d => `
                    <div class="destination-card ${d.scheduled ? 'scheduled' : 'unscheduled'}" onclick="openDateModal('${d.name.replace(/'/g, "\\'")}')">
                        <div class="flex justify-between items-center w-full">
                            <span class="truncate font-bold text-gray-700 pr-1">${d.name}</span>
                            <div class="flex items-center space-x-1 shrink-0" onclick="event.stopPropagation()">
                                 <button onclick="openGoogleMaps('${d.name.replace(/'/g, "\\'")}')" class="p-1.5 text-blue-500 hover:bg-blue-50 rounded transition" title="åœ°åœ–">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                 </button>
                                 <button onclick="removeDestination('${d.name.replace(/'/g, "\\'")}')" class="p-1.5 text-red-400 hover:bg-red-50 rounded transition">âœ•</button>
                            </div>
                        </div>
                        <span class="text-[10px] text-gray-400 mt-1 font-bold tracking-tight">${d.scheduled ? 'ğŸ“… ' + d.scheduled.date : 'æœªå®‰æ’æ—¥æœŸ'}</span>
                    </div>
                `).join('');
            }
            renderItinerary();
        };

        const renderItinerary = () => {
            const area = document.getElementById('itinerary-display-area');
            if (!area) return;
            const days = getDaysArray(appData.inputs.startDate, appData.inputs.endDate);
            if (days.length === 0) { area.innerHTML = `<div class="p-10 text-center text-gray-400 bg-white rounded-2xl border-2 border-dashed border-gray-200 font-bold">è«‹å…ˆæ–¼ä¸Šæ–¹è¨­å®šæ—…è¡Œæ—¥æœŸ</div>`; return; }
            
            area.innerHTML = days.map(day => {
                const dayEvents = appData.destinations.filter(d => d.scheduled && d.scheduled.date === day.date);
                if (!appData.dailyOrder[day.date]) appData.dailyOrder[day.date] = dayEvents.map(e => e.name);
                else {
                    const currentNames = dayEvents.map(e => e.name);
                    appData.dailyOrder[day.date] = appData.dailyOrder[day.date].filter(n => currentNames.includes(n));
                    currentNames.forEach(n => { if(!appData.dailyOrder[day.date].includes(n)) appData.dailyOrder[day.date].push(n); });
                }
                const sortedEvents = appData.dailyOrder[day.date].map(name => dayEvents.find(e => e.name === name)).filter(Boolean);

                let html = `<div class="card bg-white p-5 border-l-8 border-indigo-600 shadow-sm"><h3 class="text-xl font-bold text-gray-800 mb-5 font-bold">${day.display}</h3><div class="space-y-3 font-bold">`;
                if (day.isFirst) html += `<div class="itinerary-item border-blue-400 bg-blue-50/50"><span class="text-sm font-bold text-blue-800">ğŸ›« ${appData.inputs.departTime || '00:00'} | æŠµé”ï¼š${appData.inputs.departLocation || 'ç›®çš„åœ°'}</span></div>`;
                if (sortedEvents.length === 0) { html += `<p class="text-[10px] text-gray-300 italic pl-2 font-medium">æœ¬æ—¥ç„¡æ™¯é»æ’ç¨‹</p>`; } else {
                    sortedEvents.forEach((ev, idx) => {
                        html += `
                        <div class="itinerary-item bg-gray-50 border-indigo-200">
                            <div class="flex flex-col flex-grow">
                                <div class="flex items-center">
                                    <span class="time-tag bg-indigo-600 text-white shadow-sm">${ev.scheduled.start}-${ev.scheduled.end}</span>
                                    <span class="font-bold text-gray-700">${ev.name}</span>
                                    <button onclick="openGoogleMaps('${ev.name.replace(/'/g, "\\'")}')" class="ml-2 text-blue-400 hover:text-blue-600 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                                </div>
                                <div class="text-[10px] text-gray-400 mt-1 pl-2 font-medium tracking-tight leading-tight">ğŸš— ${ev.scheduled.transport} | ğŸ’° é ç®—: ${ev.scheduled.cost || 'å…è²»'}</div>
                            </div>
                            <div class="flex flex-col space-y-1">
                                <button onclick="moveItem('${day.date}', '${ev.name.replace(/'/g, "\\'")}', -1)" class="p-1 hover:bg-gray-200 rounded text-gray-400 ${idx===0?'opacity-0 cursor-default':'opacity-100'}">â–²</button>
                                <button onclick="moveItem('${day.date}', '${ev.name.replace(/'/g, "\\'")}', 1)" class="p-1 hover:bg-gray-200 rounded text-gray-400 ${idx===sortedEvents.length-1?'opacity-0 cursor-default':'opacity-100'}">â–¼</button>
                            </div>
                        </div>`;
                    });
                }
                if (day.isLast) html += `<div class="itinerary-item border-orange-400 bg-orange-50/50"><span class="text-sm font-bold text-orange-800">ğŸ›¬ ${appData.inputs.returnTime || '00:00'} | é›¢é–‹ï¼š${appData.inputs.returnLocation || 'å‡ºç™¼åœ°'}</span></div>`;
                html += `</div></div>`; return html;
            }).join('');
        };

        const startSync = () => {
            if (!currentUser) return;
            if (unsubscribeSync) unsubscribeSync();
            const modeBadge = document.getElementById('mode-badge');
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');

            let syncDocRef;
            if (currentMode === 'private') {
                syncDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'trips', 'active');
                if (modeBadge) { modeBadge.textContent = "å€‹äººé›²ç«¯"; modeBadge.className = "px-2 py-0.5 bg-gray-100 text-gray-500 text-[10px] rounded uppercase font-bold"; }
            } else {
                if (!currentShareId) return;
                syncDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared_trips', currentShareId);
                if (modeBadge) { modeBadge.textContent = `å…±äº«: ${currentShareId}`; modeBadge.className = "px-2 py-0.5 bg-indigo-600 text-white text-[10px] rounded uppercase font-bold shadow-md"; }
            }
            
            unsubscribeSync = onSnapshot(syncDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // åˆä½µç­–ç•¥ï¼šé›²ç«¯è³‡æ–™è¦†è“‹æœ¬åœ°
                    appData = { ...appData, ...data };
                    saveLocal(); // æ›´æ–°æœ¬åœ°å¿«å–
                    updateUI();
                    if (statusText) statusText.textContent = "åŒæ­¥ä¸­";
                    if (statusDot) statusDot.className = "status-dot online";
                } else { 
                    // æ–‡ä»¶ä¸å­˜åœ¨æ™‚ï¼Œä¸Šå‚³ç›®å‰çš„æœ¬åœ°è³‡æ–™
                    syncDataToCloud(); 
                }
            }, (err) => { if (statusText) statusText.textContent = "é€£ç·šç•°å¸¸"; });
        };

        const startLibrarySync = () => {
            if (!currentUser) return;
            const libColl = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'library');
            unsubscribeLibrary = onSnapshot(libColl, (snap) => {
                const list = [];
                snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                renderLibrary(list);
            });
        };

        const renderLibrary = (list) => {
            const container = document.getElementById('library-list');
            const badge = document.getElementById('saved-count-badge');
            if (badge) badge.textContent = list.length;
            if (!container) return;
            if (list.length === 0) { container.innerHTML = `<p class="text-center text-gray-400 text-xs py-8 font-medium">ç›®å‰ç„¡é›²ç«¯å‚™ä»½ç´€éŒ„</p>`; return; }
            container.innerHTML = list.map(trip => `
                <div class="flex justify-between items-center p-4 bg-white border border-gray-100 rounded-xl shadow-sm hover:border-indigo-300 transition">
                    <div><div class="text-sm font-bold text-gray-800">${trip.tripName}</div><div class="text-[10px] text-gray-400">${trip.saveDate}</div></div>
                    <div class="flex space-x-2 font-bold"><button onclick="loadFromLibrary('${trip.id}')" class="text-xs text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-md">è¼‰å…¥</button><button onclick="deleteFromLibrary('${trip.id}')" class="text-xs text-red-300 px-1 font-normal">åˆªé™¤</button></div>
                </div>
            `).join('');
        };

        // --- å•Ÿå‹•èˆ‡é©—è­‰ ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error("é©—è­‰å¤±æ•—", e); }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userIdEl = document.getElementById('my-user-id');
                if (userIdEl) userIdEl.textContent = user.uid.substring(0, 8);
                const statusDot = document.getElementById('status-dot');
                if (statusDot) statusDot.className = "status-dot online";
                const statusText = document.getElementById('status-text');
                if (statusText) statusText.textContent = "å·²é€£ç·š";
                startSync();
                startLibrarySync();
            }
        });

        // --- å…¨åŸŸä»‹é¢å°å‡º ---
        window.handleInputChange = () => {
            appData.inputs.startDate = document.getElementById('start-date').value;
            appData.inputs.endDate = document.getElementById('end-date').value;
            appData.inputs.hotelName = document.getElementById('hotel-name').value;
            appData.inputs.departLocation = document.getElementById('depart-location').value;
            appData.inputs.departTime = document.getElementById('depart-time').value;
            appData.inputs.returnLocation = document.getElementById('return-location').value;
            appData.inputs.returnTime = document.getElementById('return-time').value;
            syncDataToCloud(); renderItinerary();
        };
        window.toggleDestinationSection = () => {
            const content = document.getElementById('dest-section-content');
            const chevron = document.getElementById('dest-chevron');
            if (content && chevron) { content.classList.toggle('hidden'); chevron.classList.toggle('rotate-180'); }
        };
        window.addCustomDestination = () => {
            const input = document.getElementById('new-destination-name');
            if (!input) return;
            const names = input.value.split(/[,\uff0c]/).map(n => n.trim()).filter(n => n);
            names.forEach(n => { if (!appData.destinations.find(d => d.name === n)) appData.destinations.push({ name: n, scheduled: null }); });
            input.value = ''; syncDataToCloud(); updateUI();
        };
        window.handleClearAllDestinations = () => {
            window.showConfirm("ç¢ºå®šè¦æ¸…ç©ºç›®çš„åœ°æ¸…å–®ä¸Šçš„æ‰€æœ‰åœ°é»å—ï¼Ÿ", () => {
                appData.destinations = []; syncDataToCloud(); updateUI();
            });
        };
        window.removeDestination = (name) => { appData.destinations = appData.destinations.filter(d => d.name !== name); syncDataToCloud(); updateUI(); };
        window.openGoogleMaps = (name) => { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`, '_blank'); };
        window.openHotelMap = () => {
            const h = document.getElementById('hotel-name').value.trim();
            if (h) window.openGoogleMaps(h);
            else alert("è«‹å…ˆè¼¸å…¥é…’åº—åç¨±ä»¥æœå°‹åœ°åœ–");
        };
        window.importDestinationsFromTxt = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split(/\r?\n/).map(l => l.trim()).filter(l => l);
                lines.forEach(n => { if (!appData.destinations.find(d => d.name === n)) appData.destinations.push({ name: n, scheduled: null }); });
                syncDataToCloud(); updateUI(); event.target.value = '';
            };
            reader.readAsText(file);
        };
        window.moveItem = (date, name, direction) => {
            const arr = appData.dailyOrder[date];
            if (!arr) return;
            const idx = arr.indexOf(name);
            const newIdx = idx + direction;
            if (newIdx >= 0 && newIdx < arr.length) { [arr[idx], arr[newIdx]] = [arr[newIdx], arr[idx]]; syncDataToCloud(); updateUI(); }
        };
        window.swapCurrencies = () => {
            const b = document.getElementById('base-currency');
            const t = document.getElementById('target-currency');
            const tmp = b.value; b.value = t.value; t.value = tmp;
            window.fetchExchangeRate();
        };
        window.fetchExchangeRate = async () => {
            const b = document.getElementById('base-currency').value;
            const t = document.getElementById('target-currency').value;
            const a = document.getElementById('exchange-amount').value;
            const resEl = document.getElementById('exchange-result');
            const textEl = document.getElementById('exchange-result-text');
            if (resEl && textEl) {
                resEl.classList.remove('hidden');
                textEl.textContent = "æ›ç®—ä¸­...";
                try {
                    const r = await fetch(`https://api.exchangerate-api.com/v4/latest/${b}`);
                    const d = await r.json();
                    const rate = d.rates[t];
                    textEl.innerHTML = `<span class='text-[10px] text-gray-500 tracking-tight uppercase font-bold'>æ›ç®—çµæœåƒè€ƒï¼š</span><br/>${a} ${b} â‰ˆ ${(a * rate).toLocaleString(undefined, {minimumFractionDigits: 2})} ${t}`;
                } catch(e) { textEl.textContent = "åŒ¯ç‡è«‹æ±‚å¤±æ•—"; }
            }
        };
        window.exportCurrentTrip = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", `TripPlan_${new Date().toISOString().slice(0,10)}.json`);
            document.body.appendChild(dl); dl.click(); dl.remove();
        };
        window.importTripFromFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if (json.inputs && json.destinations) { appData = json; syncDataToCloud(); updateUI(); alert("è¡Œç¨‹åŒ¯å…¥æˆåŠŸï¼"); }
                } catch (err) { alert("æª”æ¡ˆè®€å–éŒ¯èª¤"); }
                event.target.value = '';
            };
            reader.readAsText(file);
        };
        window.openCloudModal = () => document.getElementById('cloud-modal').classList.remove('hidden');
        window.closeCloudModal = () => document.getElementById('cloud-modal').classList.add('hidden');
        window.openTripManagerModal = () => document.getElementById('trip-manager-modal').classList.remove('hidden');
        window.closeTripManagerModal = () => document.getElementById('trip-manager-modal').classList.add('hidden');
        window.openDateModal = (name) => {
            activeEditingName = name;
            const dest = appData.destinations.find(d => d.name === name);
            if (!dest) return;
            document.getElementById('modal-title').textContent = name;
            document.getElementById('m-start-time').value = dest.scheduled?.start || '10:00';
            document.getElementById('m-end-time').value = dest.scheduled?.end || '12:00';
            document.getElementById('m-transport').value = dest.scheduled?.transport || 'åœ°éµ/ç«è»Š';
            document.getElementById('m-cost').value = dest.scheduled?.cost || '';
            const days = getDaysArray(appData.inputs.startDate, appData.inputs.endDate);
            const container = document.getElementById('m-date-options');
            if (container) {
                container.innerHTML = days.map(d => `<label class="flex items-center p-3 border rounded-xl hover:bg-indigo-50 cursor-pointer mb-2 bg-white transition"><input type="radio" name="m-date" value="${d.date}" ${dest.scheduled?.date === d.date ? 'checked' : ''} class="mr-3 accent-indigo-600 outline-none"><span class="text-sm font-bold text-gray-700">${d.display}</span></label>`).join('');
            }
            document.getElementById('date-selector-modal').classList.remove('hidden');
        };
        window.closeDateModal = () => document.getElementById('date-selector-modal').classList.add('hidden');
        window.saveDateAssignment = () => {
            const selectedDate = document.querySelector('input[name="m-date"]:checked')?.value;
            if (!selectedDate) return;
            const dest = appData.destinations.find(d => d.name === activeEditingName);
            if (dest) {
                dest.scheduled = { date: selectedDate, start: document.getElementById('m-start-time').value, end: document.getElementById('m-end-time').value, transport: document.getElementById('m-transport').value, cost: document.getElementById('m-cost').value };
                syncDataToCloud(); updateUI(); closeDateModal();
            }
        };
        window.unassignDestination = () => { const d = appData.destinations.find(x => x.name === activeEditingName); if (d) d.scheduled = null; syncDataToCloud(); updateUI(); closeDateModal(); };
        window.switchSyncMode = (mode) => {
            currentMode = mode;
            document.getElementById('btn-mode-private').className = mode === 'private' ? "flex-1 py-2 text-sm font-bold rounded-md bg-white shadow-sm text-indigo-700 border" : "flex-1 py-2 text-sm font-medium rounded-md text-gray-500";
            document.getElementById('btn-mode-shared').className = mode === 'shared' ? "flex-1 py-2 text-sm font-bold rounded-md bg-white shadow-sm text-indigo-700 border" : "flex-1 py-2 text-sm font-medium rounded-md text-gray-500";
            document.getElementById('shared-input-area').className = mode === 'shared' ? "" : "hidden";
            if (mode === 'private') startSync();
        };
        window.joinSharedTrip = () => { const val = document.getElementById('share-id-input').value.trim().toUpperCase(); if (val) { currentShareId = val; startSync(); closeCloudModal(); } };
        window.saveToLibrary = async () => {
            const n = document.getElementById('save-trip-name').value.trim();
            if (!n || !currentUser) return;
            const tripId = `trip_${Date.now()}`;
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'library', tripId), { tripName: n, saveDate: new Date().toLocaleString(), data: JSON.parse(JSON.stringify(appData)) });
            document.getElementById('save-trip-name').value = ''; alert("å·²å‚™ä»½è‡³é›²ç«¯åº«æ¸…å–®");
        };
        window.loadFromLibrary = (id) => { window.showConfirm("è¼‰å…¥å‚™ä»½å°‡è¦†è“‹ç›®å‰ç•«é¢ä¸Šçš„ä¸€åˆ‡è®Šå‹•ï¼Œç¢ºå®šå—ï¼Ÿ", async () => { const snap = await getDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'library', id)); if (snap.exists()) { appData = snap.data().data; syncDataToCloud(); closeTripManagerModal(); } }); };
        window.deleteFromLibrary = (id) => { window.showConfirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å‚™ä»½å—ï¼Ÿ", async () => { await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'library', id)); }); };
        window.showConfirm = (msg, onOk) => { const m = document.getElementById('confirm-modal'); const msgEl = document.getElementById('confirm-message'); const okBtn = document.getElementById('confirm-ok-btn'); if (m && msgEl && okBtn) { msgEl.textContent = msg; m.classList.remove('hidden'); okBtn.onclick = () => { onOk(); m.classList.add('hidden'); }; } };
        window.closeConfirmModal = () => document.getElementById('confirm-modal').classList.add('hidden');
        window.copyItineraryToClipboard = () => {
            const days = getDaysArray(appData.inputs.startDate, appData.inputs.endDate);
            if (days.length === 0) return alert("è«‹å…ˆæ–¼ä¸Šæ–¹è¨­å®šæ—…è¡Œæ—¥æœŸ");
            let txt = `âœˆï¸ AmazingTravel è¡Œç¨‹æ‘˜è¦ âœˆï¸\nğŸ¨ ä½å®¿: ${appData.inputs.hotelName || 'æœªå®š'}\n\n`;
            days.forEach(d => {
                txt += `ã€${d.display}ã€‘\n`;
                if(d.isFirst) txt += `ğŸ›« ${appData.inputs.departTime} | æŠµé”: ${appData.inputs.departLocation}\n`;
                const events = appData.destinations.filter(e => e.scheduled && e.scheduled.date === d.date);
                events.forEach(e => txt += `â° ${e.scheduled.start}-${e.scheduled.end} | ${e.name} [${e.scheduled.transport}]\n`);
                if(d.isLast) txt += `ğŸ›¬ ${appData.inputs.returnTime} | é›¢é–‹: ${appData.inputs.returnLocation}\n`;
                txt += '\n';
            });
            const el = document.createElement('textarea'); el.value = txt; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); alert("æ‘˜è¦å·²è¤‡è£½ï¼");
        };

        // ç«‹å³åŸ·è¡Œï¼šå¾ LocalStorage è¼‰å…¥è³‡æ–™
        loadLocal();
        initAuth();
    </script>
</body>
</html>
