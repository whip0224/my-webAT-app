<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AmazingTravel - å°ˆæ¥­é›²ç«¯è¡Œç¨‹ç®¡ç†</title>
    
    <!-- PWA Meta -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">

    <!-- Service Worker è¨»å†Š -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          if (window.location.protocol.startsWith('http')) {
            navigator.serviceWorker.register('sw.js').catch(err => console.warn('PWA SW Fail:', err));
          }
        });
      }
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; overscroll-behavior-y: none; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border-radius: 1rem; }
        .destination-card { cursor: pointer; transition: transform 0.1s; padding: 0.75rem; border-radius: 0.5rem; border-left: 4px solid transparent; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 0.5rem; }
        .destination-card:active { transform: scale(0.98); }
        .unscheduled { border-left-color: #f87171; }
        .scheduled { border-left-color: #34d399; }
        .time-tag { font-weight: bold; font-size: 0.75rem; padding: 2px 8px; border-radius: 9999px; margin-right: 0.5rem; display: inline-block; background: #e0e7ff; color: #3730a3; }
        .modal { transition: opacity 0.2s ease; z-index: 50; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .online { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
        .offline { background-color: #9ca3af; }
        .ai-btn { background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%); color: white; transition: all 0.3s ease; }
        .ai-btn:hover { filter: brightness(110%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4); }
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; padding-right: 2rem; }
    </style>
</head>
<body class="p-4 pb-20 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- é ‚éƒ¨å°èˆª -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">AmazingTravel</h1>
                <div class="flex items-center space-x-2 mt-1">
                    <span class="text-xs flex items-center text-gray-500 text-nowrap">
                        <span id="status-dot" class="status-dot offline"></span>
                        <span id="status-text">åˆå§‹åŒ–ä¸­...</span>
                    </span>
                    <span id="mode-badge" class="px-2 py-0.5 bg-gray-200 text-gray-600 text-[10px] rounded font-bold uppercase">Ready</span>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2">
                <button onclick="window.copyItinerary()" class="px-4 py-2 bg-teal-600 text-white rounded-lg text-sm font-bold shadow hover:bg-teal-700 transition">è¤‡è£½æ–‡å­—</button>
                <button onclick="window.openCloudModal()" class="px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg border border-indigo-100 text-sm font-bold transition">é›²ç«¯è¨­å®š</button>
                <button onclick="window.openManagerModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 text-sm font-bold text-nowrap transition">è¡Œç¨‹ç®¡ç† (<span id="saved-count-badge">0</span>)</button>
            </div>
        </div>

        <!-- åŸºæœ¬è³‡æ–™ -->
        <div class="card bg-white p-5 mb-6">
            <h2 class="text-lg font-bold text-indigo-700 mb-3">æ—…è¡ŒåŸºæœ¬è³‡æ–™</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                <div>
                    <label class="text-xs font-bold text-gray-400 block mb-1 uppercase">Start Date</label>
                    <input type="date" id="start-date" onchange="window.handleInputChange()" class="w-full p-2 border rounded text-sm outline-none focus:border-indigo-400">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 block mb-1 uppercase">End Date</label>
                    <input type="date" id="end-date" onchange="window.handleInputChange()" class="w-full p-2 border rounded text-sm outline-none focus:border-indigo-400">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 block mb-1 uppercase tracking-tight">Hotel / Stay</label>
                    <div class="flex space-x-1">
                        <input type="text" id="hotel-name" onchange="window.handleInputChange()" placeholder="ä½å®¿åç¨±" class="w-full p-2 border rounded text-sm outline-none">
                        <button onclick="window.openHotelMap()" class="bg-blue-50 text-blue-500 p-2 rounded border border-blue-100 hover:bg-blue-100 transition" title="Google Map æœå°‹">ğŸ—ºï¸</button>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-gray-50 p-3 rounded">
                    <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Departure ğŸ›«</label>
                    <input type="text" id="depart-location" list="popular-airports" placeholder="æ©Ÿå ´/åŸå¸‚" onchange="window.handleInputChange()" class="w-full p-1 border rounded text-sm mb-1 outline-none">
                    <input type="time" id="depart-time" onchange="window.handleInputChange()" class="w-full p-1 border rounded text-sm outline-none">
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Return ğŸ›¬</label>
                    <input type="text" id="return-location" list="popular-airports" placeholder="æ©Ÿå ´/åŸå¸‚" onchange="window.handleInputChange()" class="w-full p-1 border rounded text-sm mb-1 outline-none">
                    <input type="time" id="return-time" onchange="window.handleInputChange()" class="w-full p-1 border rounded text-sm outline-none">
                </div>
            </div>
        </div>

        <datalist id="popular-airports">
            <option value="é¦™æ¸¯åœ‹éš›æ©Ÿå ´ (HKG) T1"><option value="æ±äº¬æˆç”°æ©Ÿå ´ (NRT)"><option value="æ±äº¬ç¾½ç”°æ©Ÿå ´ (HND)"><option value="å¤§é˜ªé—œè¥¿æ©Ÿå ´ (KIX)"><option value="é¦–çˆ¾ä»å·æ©Ÿå ´ (ICN)"><option value="æ›¼è°·è˜‡å‡¡ç´å¸ƒ (BKK)"><option value="å°åŒ—æ¡ƒåœ’æ©Ÿå ´ (TPE)"><option value="ç¦å²¡æ©Ÿå ´ (FUK)"><option value="æ–°åŠ å¡æ¨Ÿå®œæ©Ÿå ´ (SIN)"><option value="å€«æ•¦å¸Œæ–¯æ´› (LHR)">
        </datalist>

        <!-- åŒ¯ç‡å·¥å…· -->
        <div class="card bg-white p-5 mb-6 border-l-4 border-green-500">
            <h2 class="text-lg font-bold text-green-700 mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                å³æ™‚åŒ¯ç‡æ›ç®—
            </h2>
            <div class="flex flex-col md:flex-row gap-2 items-center">
                <select id="cur-base" class="p-2 border rounded font-bold w-full md:w-auto bg-gray-50">
                    <option value="TWD" selected>TWD - å°å¹£</option><option value="HKD">HKD - æ¸¯å¹£</option><option value="JPY">JPY - æ—¥åœ“</option><option value="KRW">KRW - éŸ“åœœ</option><option value="USD">USD - ç¾å…ƒ</option><option value="EUR">EUR - æ­å…ƒ</option><option value="CNY">CNY - äººæ°‘å¹£</option><option value="THB">THB - æ³°éŠ–</option>
                </select>
                <button onclick="window.swapCur()" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition">â‡„</button>
                <select id="cur-target" class="p-2 border rounded font-bold w-full md:w-auto bg-gray-50">
                    <option value="JPY" selected>JPY - æ—¥åœ“</option><option value="TWD">TWD - å°å¹£</option><option value="HKD">HKD - æ¸¯å¹£</option><option value="KRW">KRW - éŸ“åœœ</option><option value="USD">USD - ç¾å…ƒ</option><option value="EUR">EUR - æ­å…ƒ</option><option value="CNY">CNY - äººæ°‘å¹£</option><option value="THB">THB - æ³°éŠ–</option>
                </select>
                <input type="number" id="cur-amount" value="1000" class="p-2 border rounded w-full md:w-auto flex-grow outline-none focus:ring-1 focus:ring-green-400">
                <button onclick="window.calcRate()" class="bg-green-600 text-white px-6 py-2 rounded font-bold w-full md:w-auto hover:bg-green-700 shadow transition">æ›ç®—</button>
            </div>
            <div id="rate-result" class="mt-3 text-3xl font-black text-green-800 hidden tracking-tight"></div>
            <div class="text-[10px] text-gray-400 text-right mt-1">è³‡æ–™ä¾†æºï¼šExchangeRate-API</div>
        </div>

        <!-- ç›®çš„åœ°æ¸…å–® -->
        <div class="card bg-white p-5 mb-6">
            <div class="flex justify-between items-center mb-4 cursor-pointer select-none" onclick="window.toggleDest()">
                <h2 class="text-lg font-bold text-gray-800">ç›®çš„åœ°æ¸…å–® <span id="dest-arrow">â–¼</span></h2>
                <div class="space-x-2" onclick="event.stopPropagation()">
                    <label class="text-xs text-indigo-600 font-bold cursor-pointer hover:underline text-nowrap">åŒ¯å…¥ TXT <input type="file" onchange="window.importTxt(event)" class="hidden" accept=".txt"></label>
                    <button onclick="window.clearDest()" class="text-xs text-red-500 font-bold hover:underline">å…¨éƒ¨æ¸…ç©º</button>
                </div>
            </div>
            <div id="dest-body" class="hidden border-t pt-4">
                <div class="flex flex-wrap gap-2 mb-4">
                    <input type="text" id="new-dest" placeholder="è¼¸å…¥åœ°é» (ä¾‹å¦‚ï¼šæ±äº¬éµå¡”)" class="flex-grow p-2 border rounded text-sm outline-none focus:ring-1 focus:ring-indigo-400">
                    <button onclick="window.addDest()" class="bg-indigo-600 text-white px-6 py-2 rounded text-sm font-bold shadow hover:bg-indigo-700">æ–°å¢</button>
                    <button onclick="window.openAIModal()" class="ai-btn px-4 py-2 rounded text-sm font-bold flex items-center shadow-md text-nowrap">
                        âœ¨ AI éˆæ„Ÿ
                    </button>
                </div>
                <div id="destination-list-container" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
            </div>
        </div>

        <!-- è¡Œç¨‹é è¦½å€åŸŸ -->
        <div id="itinerary-display-area" class="space-y-4 mb-10"></div>
    </div>

    <!-- AI æ¨è–¦å½ˆçª— -->
    <div id="modal-ai" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[100] modal backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-full max-w-lg mx-4 shadow-2xl relative">
            <button onclick="document.getElementById('modal-ai').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 font-bold text-xl">âœ•</button>
            <h3 class="text-xl font-bold text-gray-800 mb-2">âœ¨ AI æ—…éŠéˆæ„ŸåŠ©æ‰‹</h3>
            <p class="text-sm text-gray-500 mb-4">AI å°‡æ ¹æ“šæ‚¨çš„ä½å®¿èˆ‡ç¾æœ‰æ™¯é»æ¨è–¦ï¼š</p>
            <textarea id="ai-prompt" class="w-full p-3 border rounded-lg bg-gray-50 text-sm mb-4 h-24 focus:ring-2 focus:ring-purple-400 outline-none resize-none"></textarea>
            <button onclick="window.fetchAISuggestions()" id="ai-gen-btn" class="w-full py-3 ai-btn rounded-xl font-bold shadow-lg flex justify-center items-center">
                <span>ç”Ÿæˆæ™ºæ…§æ¨è–¦</span>
            </button>
            <div id="ai-results" class="mt-4 space-y-2 max-h-60 overflow-y-auto hidden scrollbar-thin"></div>
        </div>
    </div>

    <!-- é›²ç«¯è¨­å®šå½ˆçª— -->
    <div id="modal-cloud" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60] modal">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-80">
            <h3 class="text-lg font-bold mb-4 text-center">é›²ç«¯åŒæ­¥è¨­å®š</h3>
            <div class="flex bg-gray-100 p-1 rounded-lg mb-4">
                <button id="btn-pri" onclick="window.setMode('private')" class="flex-1 py-1.5 rounded-md text-sm font-bold transition">å€‹äººæ¨¡å¼</button>
                <button id="btn-pub" onclick="window.setMode('shared')" class="flex-1 py-1.5 rounded-md text-sm transition">å…±äº«æ¨¡å¼</button>
            </div>
            <div id="share-input" class="hidden mb-4">
                <input id="share-key" type="text" placeholder="å…±äº«é‡‘é‘° (å¦‚: FAMILY2026)" class="w-full p-2 border rounded-md uppercase font-mono text-sm text-center">
                <button onclick="window.joinShare()" class="w-full mt-2 bg-indigo-600 text-white py-2 rounded-md font-bold text-sm shadow">è¼‰å…¥å…±äº«è¡Œç¨‹</button>
            </div>
            <div class="text-[10px] text-gray-400 mb-4 text-center border-t pt-2">æ‚¨çš„ ID: <span id="uid-disp" class="font-mono">...</span></div>
            <button onclick="document.getElementById('modal-cloud').classList.add('hidden')" class="w-full py-2 bg-gray-100 text-gray-600 rounded-lg font-bold text-sm">é—œé–‰</button>
        </div>
    </div>

    <!-- è¡Œç¨‹ç®¡ç†å½ˆçª— -->
    <div id="modal-manager" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60] modal">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-96 max-h-[85vh] flex flex-col">
            <h3 class="text-lg font-bold mb-4 border-b pb-2">è¡Œç¨‹ç®¡ç†åº«</h3>
            <div class="bg-indigo-50 p-4 rounded-xl mb-4 border border-indigo-100">
                <label class="block text-[10px] font-bold text-indigo-600 uppercase mb-2">Backup to Cloud</label>
                <div class="flex gap-2">
                    <input id="backup-name" type="text" placeholder="è¡Œç¨‹åç¨±" class="flex-grow p-2 border rounded-md text-sm outline-none">
                    <button onclick="window.saveBackup()" class="bg-indigo-600 text-white px-4 rounded-md font-bold text-sm">å„²å­˜</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="window.exportJson()" class="py-2 border border-gray-200 rounded-lg bg-white text-xs font-bold hover:bg-gray-50 transition">ğŸ“¤ åŒ¯å‡º JSON</button>
                <label class="py-2 border border-gray-200 rounded-lg bg-white text-xs font-bold hover:bg-gray-50 transition text-center cursor-pointer">
                    ğŸ“¥ åŒ¯å…¥ JSON
                    <input type="file" onchange="window.importJson(event)" class="hidden" accept=".json">
                </label>
            </div>
            <div id="backup-list" class="flex-grow overflow-y-auto space-y-2 pr-1 scrollbar-thin"></div>
            <button onclick="document.getElementById('modal-manager').classList.add('hidden')" class="w-full mt-4 py-2 bg-gray-100 text-gray-600 rounded-lg font-bold text-sm">é—œé–‰</button>
        </div>
    </div>

    <!-- ç´°ç¯€è¨­å®šå½ˆçª— -->
    <div id="modal-detail" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[110] modal">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-80">
            <h3 id="detail-title" class="text-lg font-bold mb-4 text-indigo-700 border-b pb-2">æ™¯é»ç´°ç¯€è¨­å®š</h3>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <div><label class="text-[10px] text-gray-400 font-bold block uppercase">Start</label><input type="time" id="d-start" class="w-full border p-1 rounded text-sm outline-none"></div>
                <div><label class="text-[10px] text-gray-400 font-bold block uppercase">End</label><input type="time" id="d-end" class="w-full border p-1 rounded text-sm outline-none"></div>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <div><label class="text-[10px] text-gray-400 font-bold block uppercase">Transport</label>
                    <select id="d-trans" class="w-full border p-1 rounded text-sm bg-white outline-none"><option>åœ°éµ</option><option>å·´å£«</option><option>è¨ˆç¨‹è»Š</option><option>æ­¥è¡Œ</option><option>è‡ªé§•</option></select>
                </div>
                <div><label class="text-[10px] text-gray-400 font-bold block uppercase text-nowrap">Budget (äººå‡)</label><input type="text" id="d-cost" placeholder="äººå‡" class="w-full border p-1 rounded text-sm outline-none"></div>
            </div>
            <label class="text-[10px] text-gray-400 font-bold block mb-1">SELECT DATE</label>
            <div id="d-dates" class="max-h-32 overflow-y-auto border rounded-md p-2 mb-4 text-sm bg-gray-50 flex flex-col gap-1"></div>
            <div class="flex justify-between items-center">
                <button onclick="window.detailUnset()" class="text-red-500 text-sm font-bold hover:underline">å–æ¶ˆæ’å®š</button>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('modal-detail').classList.add('hidden')" class="text-gray-400 text-sm font-bold">å–æ¶ˆ</button>
                    <button onclick="window.detailSave()" class="bg-indigo-600 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow">ç¢ºèª</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨ç¢ºèª Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[200] modal">
        <div class="bg-white p-6 rounded-2xl w-72 text-center shadow-2xl">
            <h3 class="text-lg font-bold mb-2">ç¢ºèªåŸ·è¡Œï¼Ÿ</h3>
            <p id="confirm-message" class="text-gray-500 text-sm mb-5 leading-relaxed"></p>
            <div class="flex gap-3 justify-center">
                <button onclick="document.getElementById('confirm-modal').classList.add('hidden')" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold text-sm">å–æ¶ˆ</button>
                <button id="confirm-ok-btn" class="flex-1 py-2 bg-red-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-red-100">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- æ ¸å¿ƒè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
		const appId = 'amazing-travel-v1'; // ä½ å¯ä»¥ä¿ç•™é€™å€‹ ID æˆ–è‡ªè¨‚

		// è«‹å¡«å…¥ä½ å¾ Firebase Console å–å¾—çš„çœŸå¯¦è³‡æ–™
		const firebaseConfig = {
            apiKey: "AIzaSyD-ZzGy8A0UGq-zNWUnQtyEK0L0ynSOVKU",
            authDomain: "amazingtravel-whip0224.firebaseapp.com",
            projectId: "amazingtravel-whip0224",
            storageBucket: "amazingtravel-whip0224.firebasestorage.app",
            messagingSenderId: "1054814538508",
            appId: "1:1054814538508:web:6cccb3b84034a2fcfed729",
            measurementId: "G-GF52Y8ZCZQ"
        };

		// GitHub Pages ä¸éœ€è¦ Token æ³¨å…¥ï¼Œç›´æ¥è¨­ç‚º null
		const initialAuthToken = null;


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const LS_KEY = 'at_local_data_final_v1';
        let currentUser = null;
        let currentMode = 'private';
        let currentShareId = '';
        let unsubscribeSync = null;

        // è³‡æ–™ç‹€æ…‹
        let appData = {
            inputs: { startDate: '', endDate: '', hotelName: '', departLocation: '', departTime: '10:00', returnLocation: '', returnTime: '18:00' },
            destinations: [], 
            dailyOrder: {} 
        };
        let activeEditName = null;

        // --- è¼”åŠ©å‡½å¼ ---
        const safeSet = (id, property, value) => {
            const el = document.getElementById(id);
            if (el) el[property] = value;
        };

        const getDays = () => {
            if (!appData.inputs.startDate || !appData.inputs.endDate) return [];
            const s = new Date(appData.inputs.startDate), e = new Date(appData.inputs.endDate);
            if(isNaN(s) || isNaN(e) || s > e) return [];
            const arr = [];
            let curr = new Date(s);
            while (curr <= e) {
                arr.push({ iso: curr.toISOString().split('T')[0], disp: curr.toLocaleDateString('zh-TW', {month:'short', day:'numeric', weekday:'short'}) });
                curr.setDate(curr.getDate() + 1);
            }
            return arr;
        };

        const save = () => {
            localStorage.setItem(LS_KEY, JSON.stringify(appData));
            if(currentUser) {
                // Rule 1: åš´æ ¼ä¾ç…§ artifacts è·¯å¾‘çµæ§‹
                const path = currentMode === 'private' 
                    ? doc(db, 'artifacts', appId, 'users', currentUser.uid, 'active_trip', 'data')
                    : doc(db, 'artifacts', appId, 'public', 'data', 'shares', currentShareId || 'demo');
                setDoc(path, { ...appData, updatedAt: Date.now() }).catch(e => console.error("Cloud Save Fail", e));
            }
        };

        const render = () => {
            // æ›´æ–°åŸºæœ¬è³‡æ–™æ¬„ä½
            const fieldMap = {
                'start-date': appData.inputs.startDate,
                'end-date': appData.inputs.endDate,
                'hotel-name': appData.inputs.hotelName,
                'depart-location': appData.inputs.departLocation,
                'depart-time': appData.inputs.departTime,
                'return-location': appData.inputs.returnLocation,
                'return-time': appData.inputs.returnTime
            };
            Object.entries(fieldMap).forEach(([id, val]) => safeSet(id, 'value', val || ''));

            // ç›®çš„åœ°æ¸…å–®
            const destList = document.getElementById('destination-list-container');
            if(destList) {
                destList.innerHTML = appData.destinations.map(d => `
                    <div class="destination-card ${d.scheduled ? 'scheduled' : 'unscheduled'}" onclick="window.openDateModal('${d.name.replace(/'/g, "\\'")}')">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-700 truncate pr-2">${d.name}</span>
                            <div class="flex gap-2" onclick="event.stopPropagation()">
                                <button onclick="window.openMap('${d.name.replace(/'/g, "\\'")}')" class="text-blue-500">ğŸ—ºï¸</button>
                                <button onclick="window.rmDest('${d.name.replace(/'/g, "\\'")}')" class="text-red-300">âœ•</button>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-1 font-bold">${d.scheduled ? 'ğŸ“… ' + d.scheduled.date : 'æœªå®‰æ’æ—¥æœŸ'}</div>
                    </div>
                `).join('');
            }

            // è¡Œç¨‹è¦–åœ–
            const area = document.getElementById('itinerary-display-area');
            if(area) {
                const days = getDays();
                if(days.length === 0) { 
                    area.innerHTML = '<div class="text-center text-gray-300 p-12 border-2 border-dashed rounded-2xl bg-white font-bold">è«‹å…ˆæ–¼ä¸Šæ–¹è¨­å®šã€Œå‡ºç™¼ã€èˆ‡ã€Œå›ç¨‹ã€æ—¥æœŸ</div>'; 
                    return; 
                }
                
                area.innerHTML = days.map((day, idx) => {
                    let evs = appData.destinations.filter(d => d.scheduled?.date === day.iso);
                    const order = appData.dailyOrder[day.iso] || [];
                    evs.sort((a,b) => {
                        const ia = order.indexOf(a.name), ib = order.indexOf(b.name);
                        if(ia !== -1 && ib !== -1) return ia - ib;
                        return (a.scheduled.start > b.scheduled.start) ? 1 : -1;
                    });
                    appData.dailyOrder[day.iso] = evs.map(e=>e.name);

                    let html = `<div class="card bg-white p-5 border-l-8 border-indigo-600 mb-4 shadow-sm"><h3 class="font-bold text-gray-800 mb-4 flex items-center text-lg"><span class="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm font-bold">${idx+1}</span> ${day.disp}</h3>`;
                    
                    if(idx===0) html += `<div class="p-2 mb-3 bg-blue-50/50 rounded-lg border border-blue-100"><span class="text-xs font-bold text-blue-700 uppercase">ğŸ›« Departure:</span> <span class="text-sm font-bold text-blue-800 ml-1">${appData.inputs.departTime || '00:00'} | ${appData.inputs.departLocation || '-'}</span></div>`;
                    
                    if(evs.length === 0) html += `<p class="text-xs text-gray-300 italic pl-10 py-2">æš«ç„¡æ’ç¨‹</p>`;
                    evs.forEach((e) => {
                        html += `
                        <div class="flex items-start gap-3 p-3 bg-gray-50/50 border rounded-xl mb-2 hover:border-indigo-200 transition">
                            <div class="flex flex-col items-center pt-1 shrink-0"><span class="time-tag mb-1">${e.scheduled.start}</span><div class="w-0.5 h-6 bg-indigo-100"></div><span class="time-tag mt-1">${e.scheduled.end}</span></div>
                            <div class="flex-grow">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-800">${e.name}</span>
                                    <button onclick="window.openMap('${e.name.replace(/'/g, "\\'")}')" class="text-xs text-blue-400 hover:underline">åœ°åœ–</button>
                                </div>
                                <div class="text-[10px] text-gray-400 mt-1 font-bold">ğŸš— ${e.scheduled.transport} | ğŸ’° ${e.scheduled.cost||'-'}</div>
                            </div>
                            <div class="flex flex-col gap-1">
                                <button onclick="window.mv('${day.iso}', '${e.name.replace(/'/g, "\\'")}', -1)" class="text-xs text-gray-300 hover:text-indigo-600">â–²</button>
                                <button onclick="window.mv('${day.iso}', '${e.name.replace(/'/g, "\\'")}', 1)" class="text-xs text-gray-300 hover:text-indigo-600">â–¼</button>
                            </div>
                        </div>`;
                    });

                    if(idx===days.length-1) html += `<div class="p-2 mt-4 bg-orange-50/50 rounded-lg border border-orange-100"><span class="text-xs font-bold text-orange-700 uppercase">ğŸ›¬ Return:</span> <span class="text-sm font-bold text-orange-800 ml-1">${appData.inputs.returnTime || '00:00'} | ${appData.inputs.returnLocation || '-'}</span></div>`;
                    html += `</div>`;
                    return html;
                }).join('');
            }
        };

        // --- å…¨åŸŸå‡½å¼ç¶å®š ---
        window.handleInputChange = () => {
            const fieldMap = { 'start-date': 'startDate', 'end-date': 'endDate', 'hotel-name': 'hotelName', 'depart-location': 'departLocation', 'depart-time': 'departTime', 'return-location': 'returnLocation', 'return-time': 'returnTime' };
            Object.entries(fieldMap).forEach(([id, key]) => {
                const el = document.getElementById(id);
                if(el) appData.inputs[key] = el.value;
            });
            save(); render();
        };

        window.addDest = () => {
            const el = document.getElementById('new-dest');
            if(!el || !el.value.trim()) return;
            el.value.trim().split(/[,ï¼Œ]/).forEach(n => {
                n = n.trim();
                if(n && !appData.destinations.find(d=>d.name===n)) appData.destinations.push({name:n, scheduled:null});
            });
            el.value = ''; save(); render();
        };

        window.rmDest = (n) => { appData.destinations = appData.destinations.filter(d=>d.name!==n); save(); render(); };
        window.openMap = (n) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(n)}`, '_blank');
        window.openHotelMap = () => { const h = appData.inputs.hotelName; h ? window.openMap(h) : alert("è«‹è¼¸å…¥é…’åº—åç¨±"); };
        window.toggleDest = () => {
            const body = document.getElementById('dest-body');
            const arrow = document.getElementById('dest-arrow');
            if(body) { body.classList.toggle('hidden'); if(arrow) arrow.textContent = body.classList.contains('hidden') ? 'â–¼' : 'â–²'; }
        };
        window.clearDest = () => { window.showConfirm("ç¢ºå®šæ¸…ç©ºæ¸…å–®ï¼Ÿ", () => { appData.destinations = []; save(); render(); }); };
        
        window.importTxt = (e) => {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = ev => {
                let c = 0;
                ev.target.result.split(/\r?\n/).forEach(l => {
                    const n = l.trim();
                    if(n && !appData.destinations.find(d=>d.name===n)) { appData.destinations.push({name:n, scheduled:null}); c++; }
                });
                save(); render(); e.target.value='';
                alert(`æˆåŠŸåŒ¯å…¥ ${c} å€‹åœ°é»`);
            };
            r.readAsText(f);
        };

        window.calcRate = async () => {
            const b = document.getElementById('cur-base').value, t = document.getElementById('cur-target').value, a = document.getElementById('cur-amount').value;
            const rEl = document.getElementById('rate-result');
            if(rEl) {
                rEl.classList.remove('hidden'); rEl.textContent = "è¨ˆç®—ä¸­...";
                try {
                    const res = await fetch(`https://api.exchangerate-api.com/v4/latest/${b}`);
                    const data = await res.json();
                    rEl.textContent = `${(a * data.rates[t]).toLocaleString(undefined, {minimumFractionDigits: 2})} ${t}`;
                } catch(e) { rEl.textContent = "å–å¾—åŒ¯ç‡å¤±æ•—"; }
            }
        };
        window.swapCur = () => { const b=document.getElementById('cur-base'), t=document.getElementById('cur-target'); [b.value, t.value] = [t.value, b.value]; window.calcRate(); };

        // AI
        const apiKey = ""; // ç³»çµ±æ³¨å…¥
        window.openAIModal = () => {
            const hotel = appData.inputs.hotelName || appData.inputs.departLocation || 'ç›®çš„åœ°';
            const existing = appData.destinations.map(d=>d.name).join(', ') || 'ç„¡';
            safeSet('ai-prompt', 'value', `æˆ‘ä½åœ¨ ${hotel}ï¼Œå·²å®‰æ’ï¼š${existing}ã€‚è«‹æ¨è–¦ 5 å€‹é©åˆåŠ å…¥è¡Œç¨‹çš„å‘¨é‚Šæ™¯é»æˆ–ç¾é£Ÿï¼Œä¸¦é™„ä¸Šç°¡çŸ­èªªæ˜ã€‚è«‹ä»¥ JSON æ ¼å¼å›å‚³ï¼Œæ ¼å¼ç‚ºï¼š[{"name":"åç¨±","desc":"èªªæ˜"}]`);
            document.getElementById('modal-ai').classList.remove('hidden');
        };
        window.fetchAISuggestions = async () => {
            const promptText = document.getElementById('ai-prompt').value;
            const btn = document.getElementById('ai-gen-btn'), resDiv = document.getElementById('ai-results');
            btn.innerHTML = `AI æ€è€ƒä¸­...`; btn.disabled = true; resDiv.classList.add('hidden');
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] }) });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                let suggestions = JSON.parse(text.match(/\[.*\]/s)[0]);
                resDiv.innerHTML = suggestions.map(s => `
                    <div class="flex justify-between items-start p-3 bg-gray-50 rounded-xl border hover:border-purple-300 transition group">
                        <div><div class="font-bold text-gray-800">${s.name}</div><div class="text-[10px] text-gray-500 mt-1">${s.desc}</div></div>
                        <button onclick="window.addFromAI('${s.name.replace(/'/g, "\\'")}')" class="ml-2 bg-purple-100 text-purple-600 w-8 h-8 rounded-full flex items-center justify-center font-bold">+</button>
                    </div>`).join('');
                resDiv.classList.remove('hidden');
            } catch(err) { alert("AI é€£ç·šå¤±æ•—"); } finally { btn.innerHTML = `<span>é‡æ–°ç”Ÿæˆæ¨è–¦</span>`; btn.disabled = false; }
        };
        window.addFromAI = (name) => {
            if(!appData.destinations.find(d=>d.name===name)) { appData.destinations.push({name, scheduled: null}); save(); render(); event.target.innerText = "âœ“"; setTimeout(() => document.getElementById('modal-ai').classList.add('hidden'), 600); }
        };

        // è©³ç´°è¨­å®š
        window.openDateModal = (n) => {
            activeEditName = n;
            const d = appData.destinations.find(x=>x.name===n); if(!d) return;
            safeSet('detail-title', 'textContent', n);
            safeSet('d-start', 'value', d.scheduled?.start || '10:00');
            safeSet('d-end', 'value', d.scheduled?.end || '12:00');
            safeSet('d-trans', 'value', d.scheduled?.transport || 'åœ°éµ');
            safeSet('d-cost', 'value', d.scheduled?.cost || '');
            const days = getDays();
            const datesEl = document.getElementById('d-dates');
            if(datesEl) datesEl.innerHTML = days.map(day => `<label class="flex items-center p-2 border rounded-lg cursor-pointer ${d.scheduled?.date===day.iso ? 'bg-indigo-50 border-indigo-300':'bg-white'}"><input type="radio" name="ddate" value="${day.iso}" ${d.scheduled?.date===day.iso?'checked':''} class="mr-2 accent-indigo-600"> <span class="font-bold">${day.disp}</span></label>`).join('');
            document.getElementById('modal-detail').classList.remove('hidden');
        };
        window.detailSave = () => {
            const dateEl = document.querySelector('input[name="ddate"]:checked');
            if(!dateEl) return alert("è«‹é¸æ“‡æ—¥æœŸ");
            const d = appData.destinations.find(x=>x.name===activeEditName);
            if(d) { d.scheduled = { date: dateEl.value, start: document.getElementById('d-start').value, end: document.getElementById('d-end').value, transport: document.getElementById('d-trans').value, cost: document.getElementById('d-cost').value }; save(); render(); document.getElementById('modal-detail').classList.add('hidden'); }
        };
        window.detailUnset = () => { const d = appData.destinations.find(x=>x.name===activeEditName); if(d) d.scheduled = null; save(); render(); document.getElementById('modal-detail').classList.add('hidden'); };
        window.mv = (date, name, dir) => { const arr = appData.dailyOrder[date]; if(!arr) return; const idx = arr.indexOf(name), nIdx = idx + dir; if(nIdx >= 0 && nIdx < arr.length) { [arr[idx], arr[nIdx]] = [arr[nIdx], arr[idx]]; save(); render(); } };

        // é›²ç«¯èˆ‡ç®¡ç†
        window.openCloudModal = () => document.getElementById('modal-cloud').classList.remove('hidden');
        window.openManagerModal = () => { renderBackups(); document.getElementById('modal-manager').classList.remove('hidden'); };
        window.setMode = (m) => { currentMode = m; safeSet('btn-pri', 'className', m==='private' ? "flex-1 py-1.5 rounded-md text-sm font-bold bg-white shadow text-indigo-700" : "flex-1 py-1.5 text-sm text-gray-500"); safeSet('btn-pub', 'className', m==='shared' ? "flex-1 py-1.5 rounded-md text-sm font-bold bg-white shadow text-indigo-700" : "flex-1 py-1.5 text-sm text-gray-500"); const inp = document.getElementById('share-input'); if(inp) inp.classList.toggle('hidden', m!=='shared'); startSync(); };
        window.joinShare = () => { currentShareId = document.getElementById('share-key').value.trim().toUpperCase(); startSync(); document.getElementById('modal-cloud').classList.add('hidden'); };
        window.saveBackup = async () => {
            const n = document.getElementById('backup-name').value;
            if(!n || !currentUser) return alert("è«‹ç™»å…¥å¾Œé‡è©¦");
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'backups', `bk_${Date.now()}`), { name: n, date: new Date().toLocaleString(), data: JSON.parse(JSON.stringify(appData)) });
            alert("å‚™ä»½å®Œæˆ"); safeSet('backup-name', 'value', '');
        };
        window.exportJson = () => { const dl = document.createElement('a'); dl.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData)); dl.download = `TripPlan.json`; dl.click(); };
        window.importJson = (e) => { const r = new FileReader(); r.onload = ev => { try { const d = JSON.parse(ev.target.result); if(d.inputs) { appData = d; save(); render(); alert("åŒ¯å…¥æˆåŠŸ"); } } catch(x){alert("æ ¼å¼éŒ¯èª¤");} }; r.readAsText(e.target.files[0]); };
        window.copyItinerary = () => {
            const days = getDays();
            let t = `âœˆï¸ AmazingTravel è¡Œç¨‹åˆ†äº«\n`;
            days.forEach(d => { t += `\nã€${d.disp}ã€‘\n`; const evs = appData.destinations.filter(x => x.scheduled?.date === d.iso).sort((a,b)=>a.scheduled.start > b.scheduled.start ? 1 : -1); evs.forEach(e => t += `â° ${e.scheduled.start}-${e.scheduled.end} | ${e.name} (${e.scheduled.transport})\n`); });
            const el = document.createElement('textarea'); el.value=t; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); alert("å·²è¤‡è£½ï¼");
        };
        window.showConfirm = (msg, onOk) => { const m = document.getElementById('confirm-modal'); safeSet('confirm-message', 'textContent', msg); m.classList.remove('hidden'); document.getElementById('confirm-ok-btn').onclick = () => { onOk(); m.classList.add('hidden'); }; };

        // --- åŒæ­¥æ©Ÿåˆ¶ ---
        function startSync() {
            if(unsubscribeSync) unsubscribeSync();
            if(!currentUser || !db) return;
            const path = currentMode === 'private' 
                ? doc(db, 'artifacts', appId, 'users', currentUser.uid, 'active_trip', 'data')
                : doc(db, 'artifacts', appId, 'public', 'data', 'shares', currentShareId || 'demo');
            
            unsubscribeSync = onSnapshot(path, (snap) => {
                if(snap.exists()) {
                    const cloudData = snap.data();
                    appData = { ...appData, ...cloudData };
                    render();
                }
            }, (err) => console.error("Sync Error:", err));
        }

        function renderBackups() {
            const list = document.getElementById('backup-list');
            if(!list || !currentUser) return;
            onSnapshot(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'backups'), snap => {
                safeSet('saved-count-badge', 'innerText', snap.size);
                list.innerHTML = snap.empty ? '<div class="text-center py-10 text-gray-300 text-xs">ç„¡é›²ç«¯ç´€éŒ„</div>' : '';
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const el = document.createElement('div');
                    el.className = "flex justify-between p-3 bg-white border rounded-xl items-center shadow-sm";
                    el.innerHTML = `<div><div class="font-bold text-sm text-gray-700">${d.name}</div><div class="text-[10px] text-gray-400">${d.date}</div></div>`;
                    const div = document.createElement('div'); div.className = "flex gap-2";
                    const btnLoad = document.createElement('button'); btnLoad.innerText = "è¼‰å…¥"; btnLoad.className = "text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-md";
                    btnLoad.onclick = () => { appData = d.data; save(); render(); document.getElementById('modal-manager').classList.add('hidden'); };
                    const btnDel = document.createElement('button'); btnDel.innerText = "âœ•"; btnDel.className = "text-red-300 px-1 hover:text-red-500";
                    btnDel.onclick = async () => { await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'backups', docSnap.id)); };
                    div.appendChild(btnLoad); div.appendChild(btnDel); el.appendChild(div); list.appendChild(el);
                });
            }, (err) => console.error("Backup Sync Error:", err));
        }

        // --- å•Ÿå‹•æµç¨‹ (Rule 3: Auth First) ---
        (async () => {
            // ç«‹å³è¼‰å…¥æœ¬åœ°æš«å­˜
            try { const local = localStorage.getItem(LS_KEY); if(local) { appData = JSON.parse(local); render(); } } catch(e) {}

            try {
                // åˆå§‹åŒ–èº«ä»½é©—è­‰
                const initAuth = async () => {
                    if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); }
                    else { await signInAnonymously(auth); }
                };
                
                await initAuth();

                onAuthStateChanged(auth, user => {
                    if(user) {
                        currentUser = user;
                        safeSet('uid-disp', 'innerText', user.uid.slice(0,8));
                        safeSet('status-dot', 'className', "status-dot online");
                        safeSet('status-text', 'innerText', "é€£ç·šå®Œæˆ");
                        startSync();
                        renderBackups();
                    }
                });
            } catch(err) { 
                console.error("Auth Init Fail", err);
                safeSet('status-text', 'innerText', "é›¢ç·šæ¨¡å¼å¯ç”¨"); 
            }
        })();
    </script>
</body>
</html>

